import{u as Y}from"./quota-store-CZV-NSgL.js";import{d as B,m as I,B as O,s as $,_ as z,a as g,w as n,e as d,g as F,b as l,v as M,i as u,h as f,F as R,q as P,t as Q,o as h}from"./index-D35lDKvM.js";import{u as _}from"./useForm-BgfHwkqf.js";import{u as H}from"./useToast-CJAf_JXJ.js";import{h as v}from"./errorHandler-DijQ3xmc.js";import{u as G}from"./settings-store-BSKbfzXp.js";import{M as J}from"./ModuleTable-Cq8xjBLp.js";const K=B({name:"QuotaPage",components:{ModuleTable:J},setup(){const e=$(null),t=$(null),{isValid:s,validate:o,resetValidation:i,reset:m}=_(e),{isValid:r,validate:c,resetValidation:p,reset:V}=_(t);return{isValidForm:s,validateForm:o,resetValidationForm:i,isValidSForm:r,validateSForm:c,resetValidationSForm:p,resetForm:m,resetSForm:V,formRef:e,sformRef:t,columns:[{key:"id",label:"ID",sortable:!0},{key:"name",label:"NAME",sortable:!0},{key:"start_date",label:"START DATE",sortable:!0},{key:"end_date",label:"END DATE",sortable:!0},{key:"actions",label:"ACTIONS",width:"150px"}]}},data(){return{items:[],editedItemId:null,editedItem:null,createdItem:{name:"",start_date:null,end_date:null},toast:H(),form:O({id:null,name:"",start_date:null,end_date:null,description:""}),sform:O({id:null,quantity:1,salesQuota:null,area:null}),speciesOptions:[],areasOptions:[],speciesObjects:[],showModal:!1,showDeleteModal:!1,quotasOptions:[],showQuotaList:!0,quotaItems:[],savingQuotaSpecies:!1,loadingQuotas:!1,savingQuota:!1,deletingQuota:!1,isEditing:!1,quotaToDelete:null,currentViewQuota:null}},mounted(){this.getQs(),this.getSpeciesItems(),this.getAreas()},methods:{...I(Y,["getQuotas","createQuota","updateQuota","deleteQuota","getSpeciesList","getAreaList","createQuotaAreaSpecies"]),...I(G,["getLicenceRegulatoryHuntingPackageSpecies"]),formatDate(e){if(!e)return"";const t=new Date(e),s=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${s}-${o}-${i}`},formatDisplayDate(e){return e?new Date(e).toLocaleDateString():"-"},generateQuotaYear(e,t){if(!e||!t)return"";const s=new Date(e).getFullYear(),o=new Date(t).getFullYear();return`${s}-${o}`},resetModal(){this.isEditing=!1,this.showModal=!1,this.form.id=null,this.form.name="",this.form.start_date=null,this.form.end_date=null,this.form.description="",this.formRef&&this.resetValidationForm()},toggleQuotaView(){this.showQuotaList=!this.showQuotaList,this.showQuotaList&&(this.currentViewQuota=null,this.sform.salesQuota=null)},viewQuotaDetails(e){console.log("View quota details:",e),this.showQuotaList=!1,this.currentViewQuota=e,this.sform.salesQuota={value:e.id,text:this.generateQuotaYear(e.start_date,e.end_date)+` - ${e.name}`},this.getSpeciesItems()},editQuota(e){console.log("Edit quota:",e),this.isEditing=!0,this.form.id=e.id,this.form.name=e.name,this.form.start_date=e.start_date?new Date(e.start_date):null,this.form.end_date=e.end_date?new Date(e.end_date):null,this.form.description=e.description||"",this.showModal=!0},confirmDeleteQuota(e){console.log("Delete quota:",e),this.quotaToDelete=e,this.showDeleteModal=!0},cancelDelete(){this.quotaToDelete=null,this.showDeleteModal=!1},async deleteQuotaItem(){var e,t,s,o,i,m;if(this.quotaToDelete){this.deletingQuota=!0;try{const r=await this.deleteQuota(this.quotaToDelete.id);r.status===200||r.status===204||((e=r.data)==null?void 0:e.success)?(this.toast.init({message:((t=r.data)==null?void 0:t.message)||"Quota deleted successfully",color:"success"}),this.items=this.items.filter(p=>p.id!==this.quotaToDelete.id),this.quotasOptions=this.quotasOptions.filter(p=>p.value!==this.quotaToDelete.id),this.cancelDelete()):this.toast.init({message:((s=r.data)==null?void 0:s.message)||"Delete operation failed",color:"warning"})}catch(r){console.error("Delete error:",r),((o=r.response)==null?void 0:o.status)===405?(this.toast.init({message:"Delete method not supported by API. Removing locally.",color:"warning"}),this.items=this.items.filter(c=>c.id!==this.quotaToDelete.id),this.quotasOptions=this.quotasOptions.filter(c=>c.value!==this.quotaToDelete.id),this.cancelDelete()):this.toast.init({message:((m=(i=r.response)==null?void 0:i.data)==null?void 0:m.message)||"Failed to delete quota",color:"danger"})}finally{this.deletingQuota=!1}}},async updateQuotaItem(){if(this.form.id){this.savingQuota=!0;try{const e={id:this.form.id,name:this.form.name,start_date:this.formatDate(this.form.start_date),end_date:this.formatDate(this.form.end_date),description:this.form.description};console.log("Updating quota with data:",e);const t=await this.updateQuota(e);if(t.status===200){this.toast.init({message:t.data.message||"Quota updated successfully",color:"success"});const s=this.items.findIndex(o=>o.id===this.form.id);if(s!==-1){const o={...this.items[s],name:this.form.name,start_date:this.formatDate(this.form.start_date),end_date:this.formatDate(this.form.end_date)};this.items=[...this.items.slice(0,s),o,...this.items.slice(s+1)];const i=this.quotasOptions.findIndex(m=>m.value===this.form.id);if(i!==-1){const m=this.generateQuotaYear(this.formatDate(this.form.start_date),this.formatDate(this.form.end_date));this.quotasOptions=[...this.quotasOptions.slice(0,i),{value:this.form.id,text:`${m} - ${this.form.name}`},...this.quotasOptions.slice(i+1)]}}this.resetModal(),this.showModal=!1}}catch(e){const t=v(e);this.toast.init({message:`
`+t.map((s,o)=>`${o+1}. ${s}`).join(`
`),color:"danger"})}finally{this.savingQuota=!1}}},showAddQuotaModal(){this.resetModal(),this.isEditing=!1,this.showModal=!0},async getQs(e=null){console.log("Fetching quotas..."),this.loadingQuotas=!0;try{const t=await this.getQuotas(e);if(t&&t.data){const s=t.data;if(s.success===!0&&Array.isArray(s.data)){const o=s.data;this.items=o.map(i=>({id:i.id,name:i.name,start_date:i.start_date,end_date:i.end_date})),this.quotasOptions=o.map(i=>{const m=this.generateQuotaYear(i.start_date,i.end_date);return{value:i.id,text:`${m} - ${i.name}`}})}else console.error("API response indicates failure or invalid data structure"),this.items=[],this.quotasOptions=[];this.loadingQuotas=!1}else console.error("Invalid response from API"),this.items=[],this.quotasOptions=[],this.loadingQuotas=!1}catch(t){this.loadingQuotas=!1,console.error("Error fetching quotas:",t),this.toast.init({message:"Failed to load quotas. Please try again.",color:"danger"})}},async getSpeciesItems(){try{const t=(await this.getSpeciesList()).data.map(s=>({value:s.id,text:s.name}));this.speciesOptions=t}catch(e){console.log("Error fetching species:",e)}},async getAreas(){try{const e=await this.getAreaList();this.areasOptions=e.data.map(t=>({value:t.id,text:t.name}))}catch(e){console.log("Error fetching areas:",e)}},resetEditedItem(){this.editedItem=null,this.editedItemId=null},resetCreatedItem(){this.createdItem={name:"",start_date:null,end_date:null}},updateQuantitySelectedSpecies(e){e&&e.quantity&&(this.sform.quantity=e.quantity)},addNewSpeciesItemToStorage(){if(!this.sform.id||!this.sform.id.value||!this.sform.id.text||!this.sform.quantity){console.error("Error: Some required fields are null or undefined.");return}if(Number(this.sform.quantity)<=0)return;this.speciesObjects.some(t=>t.id===this.sform.id.value)?console.log("Species item already exists:",this.sform.id):this.speciesObjects.push({id:this.sform.id.value,name:this.sform.id.text,quantity:this.sform.quantity})},deleteFromStorage(e){this.speciesObjects.splice(e,1)},async addNewSpeciesToQuota(){if(this.savingQuotaSpecies=!0,this.speciesObjects.length===0){this.toast.init({message:"Please add at least one species item.",color:"warning"}),this.savingQuotaSpecies=!1;return}if(!this.sform.area||!this.sform.salesQuota){this.toast.init({message:"Please select both area and sales quota.",color:"warning"}),this.savingQuotaSpecies=!1;return}const e={area_id:this.sform.area.value,quota_id:this.sform.salesQuota.value,speciesObjects:this.speciesObjects};try{const t=await this.createQuotaAreaSpecies(e);t.status===201&&(this.savingQuotaSpecies=!1,this.toast.init({message:t.data.message,color:"success"}),this.resetSForm(),this.resetCreatedItem(),this.speciesObjects=[])}catch(t){const s=v(t);this.savingQuotaSpecies=!1,this.toast.init({message:`
`+s.map((o,i)=>`${i+1}. ${o}`).join(`
`),color:"danger"})}},async createNewQuota(){this.savingQuota=!0;const e=s=>{if(!s)return"";if(s instanceof Date){const o=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),m=String(s.getDate()).padStart(2,"0");return`${o}-${i}-${m}`}if(typeof s=="string"){if(s.match(/^\d{4}-\d{2}-\d{2}$/))return s;const o=new Date(s);if(!isNaN(o.getTime())){const i=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0");return`${i}-${m}-${r}`}}return String(s)},t={name:this.form.name,start_date:e(this.form.start_date),end_date:e(this.form.end_date),description:this.form.description||""};console.log("Creating quota with data:",t);try{const s=await this.createQuota(t);if(s.success||s.status===201)this.savingQuota=!1,this.toast.init({message:s.message||"Quota created successfully",color:"success"}),this.resetForm(),this.getQs(),this.showModal=!1,this.resetCreatedItem();else{this.savingQuota=!1;const o=v(s);this.toast.init({message:`
`+o.map((i,m)=>`${m+1}. ${i}`).join(`
`),color:"danger"})}}catch(s){this.savingQuota=!1,console.error("Error creating quota:",s),this.toast.init({message:s.message||"Failed to create quota",color:"danger"})}}}}),W={class:"flex flex-col md:flex-row gap-2 mb-2 justify-between"},X={class:"flex flex-col md:flex-row gap-2 justify-start"},Z={key:1,class:"p-2"},x={class:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-4"},ee={class:"flex flex-col md:flex-row gap-2 mb-2 justify-between"},te={class:"flex flex-col md:flex-row gap-2 justify-start"},se={class:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-4"},ae={class:"mb-6"},oe={class:"mb-6"},ie={class:"font-bold text-lg mb-4"},le={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"},ne={class:"mb-4"},re={class:"p-6"},de={class:"mb-6 text-center"},ue={class:"flex justify-center gap-4"};function me(e,t,s,o,i,m){const r=u("VaButton"),c=u("VaButtonGroup"),p=u("ModuleTable"),V=u("VaIcon"),y=u("VaSelect"),L=u("VaValue"),A=u("VaDivider"),C=u("VaCounter"),b=u("VaForm"),k=u("VaListLabel"),q=u("VaListItemLabel"),E=u("VaListItemSection"),T=u("VaListItem"),N=u("VaList"),j=u("VaInput"),w=u("VaDateInput"),D=u("VaModal"),U=u("VaCard");return h(),g(U,{class:"p-6"},{default:n(()=>[d("div",W,[d("div",X,[e.showQuotaList?M("",!0):(h(),g(r,{key:0,class:"px-2 py-2",icon:"arrow_back",size:"small",onClick:e.toggleQuotaView},{default:n(()=>t[17]||(t[17]=[f(" Go Back ")])),_:1},8,["onClick"]))]),l(c,null,{default:n(()=>[l(r,{class:"px-2 py-2",color:"primary",label:"Add New Quota",icon:"add",size:"small",onClick:t[0]||(t[0]=a=>e.showAddQuotaModal())},{default:n(()=>t[18]||(t[18]=[f(" Add a New Quota ")])),_:1})]),_:1})]),e.showQuotaList?(h(),g(p,{key:0,items:e.items,columns:e.columns,loading:e.loadingQuotas,"btn-view-icon":"visibility","show-edit":!0,"show-delete":!0,onOnView:e.viewQuotaDetails,onOnEdit:e.editQuota,onOnDelete:e.confirmDeleteQuota},null,8,["items","columns","loading","onOnView","onOnEdit","onOnDelete"])):(h(),F("div",Z,[l(b,{ref:"sformRef",class:"mb-6"},{default:n(()=>[d("div",x,[l(L,{"default-value":!1},{default:n(()=>[l(y,{modelValue:e.sform.salesQuota,"onUpdate:modelValue":t[1]||(t[1]=a=>e.sform.salesQuota=a),options:e.quotasOptions,label:"Sales Quota",rules:[a=>!!a||"Sales Quota is required"],placeholder:"Select Sales Quota",disabled:!0},{appendInner:n(()=>[l(V,{name:"av_timer",size:"small",color:"primary"})]),_:1},8,["modelValue","options","rules"])]),_:1}),l(y,{modelValue:e.sform.area,"onUpdate:modelValue":t[2]||(t[2]=a=>e.sform.area=a),label:"Hunting Area",options:e.areasOptions,placeholder:"Select Hunting Area",rules:[a=>!!a||"Hunting Area is required"],required:""},null,8,["modelValue","options","rules"])]),l(A,{orientation:"left",class:"py-12"},{default:n(()=>t[19]||(t[19]=[d("span",{caption:"",class:"px-2"},"Add a List of Species",-1)])),_:1}),d("div",ee,[d("div",te,[d("div",se,[l(y,{modelValue:e.sform.id,"onUpdate:modelValue":[t[3]||(t[3]=a=>e.sform.id=a),e.updateQuantitySelectedSpecies],label:"Species",options:e.speciesOptions,placeholder:"Select Species",rules:[a=>!!a||"Species is required"],required:""},null,8,["modelValue","options","rules","onUpdate:modelValue"]),l(C,{modelValue:e.sform.quantity,"onUpdate:modelValue":t[4]||(t[4]=a=>e.sform.quantity=a),label:"Quantity","manual-input":"",min:1,max:100},null,8,["modelValue"])])]),l(c,null,{default:n(()=>[l(r,{class:"px-0 py-0",color:"primary",icon:"add",size:"small",round:"",onClick:t[5]||(t[5]=a=>e.addNewSpeciesItemToStorage())})]),_:1})])]),_:1},512),d("div",ae,[l(N,null,{default:n(()=>[e.speciesObjects.length>0?(h(),g(k,{key:0,class:"text-md mb-2 text-left"},{default:n(()=>t[20]||(t[20]=[f("Selected Species")])),_:1})):M("",!0),(h(!0),F(R,null,P(e.speciesObjects,(a,S)=>(h(),g(T,{key:S,class:"list__item"},{default:n(()=>[l(E,null,{default:n(()=>[l(q,null,{default:n(()=>[f(" Name: "+Q(a.name)+" ",1),l(V,{name:"delete",size:"small",color:"primary",onClick:fe=>e.deleteFromStorage(S)},null,8,["onClick"])]),_:2},1024),l(q,{caption:""},{default:n(()=>[f("Quantity: "+Q(a.quantity),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),d("div",oe,[l(r,{disabled:!e.isValidSForm,color:"primary",loading:e.savingQuotaSpecies,icon:"save","icon-color":"#fff",onClick:t[6]||(t[6]=a=>e.validateSForm()&&e.addNewSpeciesToQuota())},{default:n(()=>t[21]||(t[21]=[f(" save ")])),_:1},8,["disabled","loading"])])])),l(D,{modelValue:e.showModal,"onUpdate:modelValue":t[12]||(t[12]=a=>e.showModal=a),"z-index":"1",overlay:!1,size:"small","hide-default-actions":"",onCancel:t[13]||(t[13]=a=>e.resetModal())},{default:n(()=>[l(b,{ref:"formRef",class:"p-6"},{default:n(()=>[d("h3",ie,Q(e.isEditing?"Edit Quota":"Add Quota"),1),d("div",le,[l(j,{modelValue:e.form.name,"onUpdate:modelValue":t[7]||(t[7]=a=>e.form.name=a),label:"Name",placeholder:"Enter Quota Name",type:"text",rules:[a=>!!a||"Name is required"],required:""},null,8,["modelValue","rules"]),l(w,{modelValue:e.form.start_date,"onUpdate:modelValue":t[8]||(t[8]=a=>e.form.start_date=a),label:"Start Date",rules:[a=>!!a||"Start Date is required"],"manual-input":"",placeholder:"Select a date"},null,8,["modelValue","rules"]),l(w,{modelValue:e.form.end_date,"onUpdate:modelValue":t[9]||(t[9]=a=>e.form.end_date=a),label:"End Date",rules:[a=>!!a||"End Date is required"],"manual-input":"",placeholder:"Select a date"},null,8,["modelValue","rules"])]),d("div",ne,[l(r,{loading:e.savingQuota,disabled:!e.isValidForm||e.savingQuota,color:"primary",onClick:t[10]||(t[10]=a=>e.isEditing?e.updateQuotaItem():e.createNewQuota())},{default:n(()=>[f(Q(e.isEditing?"Update":"Save"),1)]),_:1},8,["loading","disabled"]),l(r,{class:"ml-2",color:"secondary",disabled:e.savingQuota,onClick:t[11]||(t[11]=a=>e.resetModal())},{default:n(()=>t[22]||(t[22]=[f(" Cancel ")])),_:1},8,["disabled"])])]),_:1},512)]),_:1},8,["modelValue"]),l(D,{modelValue:e.showDeleteModal,"onUpdate:modelValue":t[16]||(t[16]=a=>e.showDeleteModal=a),"z-index":"1",overlay:!1,size:"small","hide-default-actions":""},{default:n(()=>{var a;return[d("div",re,[t[29]||(t[29]=d("h3",{class:"font-bold text-lg mb-4 text-center"},"Confirm Delete",-1)),d("p",de,[t[23]||(t[23]=f(" Are you sure you want to delete quota ")),d("strong",null,'"'+Q((a=e.quotaToDelete)==null?void 0:a.name)+'"',1),t[24]||(t[24]=f("? ")),t[25]||(t[25]=d("br",null,null,-1)),t[26]||(t[26]=d("span",{class:"text-sm text-gray-500"},"This action cannot be undone.",-1))]),d("div",ue,[l(r,{color:"danger",loading:e.deletingQuota,onClick:t[14]||(t[14]=S=>e.deleteQuotaItem())},{default:n(()=>t[27]||(t[27]=[f(" Delete ")])),_:1},8,["loading"]),l(r,{color:"secondary",disabled:e.deletingQuota,onClick:t[15]||(t[15]=S=>e.cancelDelete())},{default:n(()=>t[28]||(t[28]=[f(" Cancel ")])),_:1},8,["disabled"])])])]}),_:1},8,["modelValue"])]),_:1})}const Se=z(K,[["render",me]]);export{Se as default};
//# sourceMappingURL=ManageQuota-D0M4PKmc.js.map
