import{j as H,k as V,d as T,p as B,h as c,e as a,s as v,F as N,q as E,b as n,w as l,i as h,r as f,o as i,g as D,n as G,a as I,t as o,m as W,l as L}from"./index-Dg6zTblr.js";import{u as Q}from"./settings-store-D7r1TkyV.js";const j=H("proposals",{state:()=>({proposals:[],currentProposal:null,pipeline:{new_inquiries:[],pending:[],provision_sales:[],confirmed:[],cancelled:[],completed:[]},pipelineCounts:{new_inquiries:0,pending:0,provision_sales:0,confirmed:0,cancelled:0,completed:0},pipelineTotal:0,paymentStatus:null,loading:!1,saving:!1,error:null}),getters:{getProposalById:e=>t=>e.proposals.find(s=>s.id===t),pendingProposals:e=>e.proposals.filter(t=>t.status==="pending"),confirmedProposals:e=>e.proposals.filter(t=>t.status==="confirmed"),newInquiries:e=>e.pipeline.new_inquiries,pendingItems:e=>e.pipeline.pending,provisionSalesItems:e=>e.pipeline.provision_sales,confirmedItems:e=>e.pipeline.confirmed,cancelledItems:e=>e.pipeline.cancelled,completedItems:e=>e.pipeline.completed},actions:{async fetchPipeline(e,t){this.loading=!0,this.error=null;try{let s="https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/pipeline";const r=new URLSearchParams;e&&r.append("stage",e),t&&r.append("season_id",String(t)),r.toString()&&(s+=`?${r.toString()}`);const y=await V.get(s);return y.data.success&&(this.pipeline=y.data.data,this.pipelineCounts=y.data.counts,this.pipelineTotal=y.data.total),y}catch(s){throw this.error=s.message||"Failed to fetch pipeline",console.error("Error fetching pipeline:",s),s}finally{this.loading=!1}},async updatePipelineStage(e,t){this.saving=!0,this.error=null;try{const s=`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/pipeline/${e}/stage`,r=await V.put(s,{stage:t});return r.data.success&&await this.fetchPipeline(),r}catch(s){throw this.error=s.message||"Failed to update stage",console.error("Error updating pipeline stage:",s),s}finally{this.saving=!1}},async fetchProposals(){this.loading=!0,this.error=null;try{const t=await V.get("https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/proposals");return t.data.success?this.proposals=t.data.data:this.proposals=Array.isArray(t.data)?t.data:[],t}catch(e){throw this.error=e.message||"Failed to fetch proposals",console.error("Error fetching proposals:",e),e}finally{this.loading=!1}},async fetchProposalById(e){this.loading=!0,this.error=null;try{const t=`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/proposals/${e}`,s=await V.get(t);return s.data.success?this.currentProposal=s.data.data:this.currentProposal=s.data,s}catch(t){throw this.error=t.message||"Failed to fetch proposal",console.error("Error fetching proposal:",t),t}finally{this.loading=!1}},async createProposal(e){this.saving=!0,this.error=null;try{const s=await V.post("https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/proposals",e);return s.data.success&&s.data.data&&this.proposals.push(s.data.data),s}catch(t){throw this.error=t.message||"Failed to create proposal",console.error("Error creating proposal:",t),t}finally{this.saving=!1}},async updateProposal(e,t){var s;this.saving=!0,this.error=null;try{const r=`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/proposals/${e}`,y=await V.put(r,t);if(y.data.success&&y.data.data){const g=this.proposals.findIndex(p=>p.id===e);g!==-1&&(this.proposals[g]=y.data.data),((s=this.currentProposal)==null?void 0:s.id)===e&&(this.currentProposal=y.data.data)}return y}catch(r){throw this.error=r.message||"Failed to update proposal",console.error("Error updating proposal:",r),r}finally{this.saving=!1}},async updateProposalStatus(e,t){return this.updateProposal(e,{status:t})},async fetchPayments(e){this.loading=!0,this.error=null;try{const t=`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/proposals/${e}/payments`,s=await V.get(t);return s.data.success&&(this.paymentStatus=s.data.data),s}catch(t){throw this.error=t.message||"Failed to fetch payments",console.error("Error fetching payments:",t),t}finally{this.loading=!1}},async recordPayment(e,t){this.saving=!0,this.error=null;try{const s=`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/installments/${e}/pay`,r=await V.post(s,t);return r.data.success&&this.paymentStatus&&await this.fetchPayments(this.paymentStatus.proposal_id),r.data.success&&this.currentProposal&&await this.fetchProposalById(this.currentProposal.id),r.data}catch(s){throw this.error=s.message||"Failed to record payment",console.error("Error recording payment:",s),s}finally{this.saving=!1}},async unpayInstallment(e){this.saving=!0,this.error=null;try{const t=`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/installments/${e}/unpay`,s=await V.post(t);return s.data.success&&this.paymentStatus&&await this.fetchPayments(this.paymentStatus.proposal_id),s.data.success&&this.currentProposal&&await this.fetchProposalById(this.currentProposal.id),s.data}catch(t){throw this.error=t.message||"Failed to reverse payment",console.error("Error reversing payment:",t),t}finally{this.saving=!1}},async deletePayment(e){this.saving=!0,this.error=null;try{const t=`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/payments/${e}`,s=await V.delete(t);return s.data.success&&this.paymentStatus&&await this.fetchPayments(this.paymentStatus.proposal_id),s.data.success&&this.currentProposal&&await this.fetchProposalById(this.currentProposal.id),s.data}catch(t){throw this.error=t.message||"Failed to delete payment",console.error("Error deleting payment:",t),t}finally{this.saving=!1}},clearPaymentStatus(){this.paymentStatus=null},clearCurrentProposal(){this.currentProposal=null,this.paymentStatus=null},clearError(){this.error=null}}}),X=T({name:"StageIndicator",props:{currentStage:{type:String,required:!0},installments:{type:Array,default:()=>[]}},data(){return{stages:[{value:"new_inquiries",label:"NEW"},{value:"pending",label:"PEND"},{value:"provision_sales",label:"PROV"},{value:"confirmed",label:"CONF"},{value:"completed",label:"COMP"}],stageColors:{new_inquiries:"#E3F2FD",pending:"#FFF9C4",provision_sales:"#FFE0B2",confirmed:"#C8E6C9",cancelled:"#FFCDD2",completed:"#E1BEE7"},stageActiveColors:{new_inquiries:"#2196F3",pending:"#FFC107",provision_sales:"#FF9800",confirmed:"#4CAF50",cancelled:"#F44336",completed:"#9C27B0"}}},computed:{stageOrder(){return this.stages.map(e=>e.value)},currentStageIndex(){return this.stageOrder.indexOf(this.currentStage)},mainInstallments(){return this.installments.filter(e=>{var r;const t=((r=e.installment_type)==null?void 0:r.toLowerCase())||"",s=e.narration.toLowerCase();return t.includes("deposit")||t.includes("final")||t.includes("trophy")||s.includes("deposit")||s.includes("final")||s.includes("trophy")})}},methods:{isStageCompleted(e){return this.currentStage==="cancelled"?!1:this.stageOrder.indexOf(e)<this.currentStageIndex},getStageColor(e){return this.currentStage==="cancelled"?this.stageActiveColors.cancelled:this.isStageCompleted(e)||this.currentStage===e?this.stageActiveColors[e]||this.stageActiveColors.pending:"#e0e0e0"},getShortLabel(e){const t=e.narration.toLowerCase();return t.includes("deposit")&&t.includes("booking")?"Deposit":t.includes("2nd")||t.includes("year prior")?"2nd":t.includes("final")?"Final":t.includes("trophy")?"Trophy":e.narration.substring(0,6)}}}),Y={class:"stage-indicator"},J={class:"stage-progress"},K={key:2,class:"stage-number"},Z={class:"stage-label"},x={key:0,class:"payment-indicators"},ee=["title"],te={class:"payment-label"},ae={key:1,class:"cancelled-overlay"};function se(e,t,s,r,y,g){const p=f("VaIcon"),S=f("VaChip");return i(),c("div",Y,[a("div",J,[(i(!0),c(N,null,E(e.stages,(u,_)=>(i(),c("div",{key:u.value,class:D(["stage-step",{"is-active":e.currentStage===u.value,"is-completed":e.isStageCompleted(u.value),"is-cancelled":e.currentStage==="cancelled"}])},[a("div",{class:"stage-dot",style:G({backgroundColor:e.getStageColor(u.value)})},[e.isStageCompleted(u.value)?(i(),I(p,{key:0,name:"check",size:"small",color:"white"})):e.currentStage==="cancelled"?(i(),I(p,{key:1,name:"close",size:"small",color:"white"})):(i(),c("span",K,o(_+1),1))],4),a("div",Z,o(u.label),1),_<e.stages.length-1?(i(),c("div",{key:0,class:D(["stage-line",{"is-filled":e.isStageCompleted(u.value)}])},null,2)):v("",!0)],2))),128))]),e.installments&&e.installments.length>0?(i(),c("div",x,[(i(!0),c(N,null,E(e.mainInstallments,u=>(i(),c("div",{key:u.id,class:D(["payment-indicator",{"is-paid":u.is_paid}]),title:u.narration},[n(p,{name:u.is_paid?"check_circle":"radio_button_unchecked",color:u.is_paid?"success":"secondary",size:"small"},null,8,["name","color"]),a("span",te,o(e.getShortLabel(u)),1)],10,ee))),128))])):v("",!0),e.currentStage==="cancelled"?(i(),c("div",ae,[n(S,{color:"danger",size:"small"},{default:l(()=>t[0]||(t[0]=[h("CANCELLED")])),_:1})])):v("",!0)])}const ne=B(X,[["render",se],["__scopeId","data-v-934a1ecb"]]),oe=T({name:"PaymentTable",props:{installments:{type:Array,default:()=>[]},summary:{type:Object,default:null},totalAmount:{type:Number,default:0},loading:{type:Boolean,default:!1},allowUnpay:{type:Boolean,default:!0}},emits:["record-payment","unpay"],computed:{paymentPercentage(){return!this.summary||this.summary.total_due===0?0:Math.round(this.summary.total_paid/this.summary.total_due*100)},totalInstallmentCount(){return this.summary?(this.summary.fully_paid_count||this.summary.paid_count||0)+(this.summary.partial_paid_count||0)+(this.summary.unpaid_count||0):this.installments.length}},methods:{getStatusIcon(e){return e.is_paid||e.payment_status==="paid"?"check_circle":e.payment_status==="partial"?"hourglass_top":"radio_button_unchecked"},getStatusIconColor(e){return e.is_paid||e.payment_status==="paid"?"success":e.payment_status==="partial"?"warning":"secondary"},formatCurrency(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)},formatDate(e){if(!e)return"";try{return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch{return e}},formatStageName(e){return{provision_sales:"Provision Sales",confirmed:"Confirmed",completed:"Completed"}[e]||e.replace(/_/g," ")}}}),le={class:"flex items-center gap-2"},re={class:"total-badge"},ie={key:0,class:"loading-state"},de={key:1,class:"payment-rows"},pe={class:"status-icon"},ue={class:"installment-details"},me={class:"narration"},ce={key:0,class:"triggers-badge"},ye={key:1,class:"partial-info"},fe={class:"text-xs text-orange-600"},he={key:2,class:"payments-count"},ge={class:"amount-section"},_e={class:"amount"},ve={class:"action-section"},be={key:0,class:"paid-info"},we={key:0,class:"paid-date"},Se={key:1,class:"partial-actions"},Ce={key:2,class:"payment-summary"},Pe={class:"summary-item paid"},$e={class:"summary-item remaining"},ke={class:"summary-item count"},Ve={key:3,class:"payment-progress"};function Ie(e,t,s,r,y,g){const p=f("VaIcon"),S=f("VaCardTitle"),u=f("VaProgressBar"),_=f("VaChip"),b=f("VaButton"),w=f("VaCardContent"),P=f("VaCard");return i(),I(P,{outlined:"",class:"payment-table-card"},{default:l(()=>[n(S,{class:"flex items-center justify-between"},{default:l(()=>{var d;return[a("div",le,[n(p,{name:"payments",color:"primary"}),t[0]||(t[0]=a("span",null,"Payment Schedule",-1))]),a("div",re,"Total: "+o(e.formatCurrency(((d=e.summary)==null?void 0:d.total_due)||e.totalAmount)),1)]}),_:1}),n(w,null,{default:l(()=>[e.loading?(i(),c("div",ie,[n(u,{indeterminate:""}),t[1]||(t[1]=a("p",{class:"text-center mt-2 text-gray-600"},"Loading payment status...",-1))])):(i(),c("div",de,[(i(!0),c(N,null,E(e.installments,d=>(i(),c("div",{key:d.id,class:D(["payment-row",{"is-paid":d.is_paid||d.payment_status==="paid","is-partial":d.payment_status==="partial"}])},[a("div",pe,[n(p,{name:e.getStatusIcon(d),color:e.getStatusIconColor(d)},null,8,["name","color"])]),a("div",ue,[a("div",me,o(d.narration),1),d.triggers_stage?(i(),c("div",ce,[n(_,{size:"small",color:"info",flat:""},{default:l(()=>[h(" â†’ "+o(e.formatStageName(d.triggers_stage)),1)]),_:2},1024)])):v("",!0),d.payment_status==="partial"?(i(),c("div",ye,[a("span",fe," Paid: "+o(e.formatCurrency(d.amount_paid||0))+" / Remaining: "+o(e.formatCurrency(d.remaining_balance||0)),1)])):v("",!0),d.payments&&d.payments.length>1?(i(),c("div",he,[n(_,{size:"small",color:"secondary",flat:""},{default:l(()=>[h(o(d.payments.length)+" payments ",1)]),_:2},1024)])):v("",!0)]),a("div",ge,[a("span",_e,o(e.formatCurrency(d.amount_due)),1)]),a("div",ve,[d.is_paid||d.payment_status==="paid"?(i(),c("div",be,[t[2]||(t[2]=a("span",{class:"paid-badge"},"PAID",-1)),d.paid_at?(i(),c("span",we,o(e.formatDate(d.paid_at)),1)):v("",!0),e.allowUnpay?(i(),I(b,{key:1,preset:"plain",size:"small",color:"secondary",icon:"undo",title:"Reverse All Payments",onClick:C=>e.$emit("unpay",d)},null,8,["onClick"])):v("",!0)])):d.payment_status==="partial"?(i(),c("div",Se,[t[4]||(t[4]=a("span",{class:"partial-badge"},"PARTIAL",-1)),n(b,{size:"small",color:"warning",onClick:C=>e.$emit("record-payment",d)},{default:l(()=>t[3]||(t[3]=[h(" Add Payment ")])),_:2},1032,["onClick"]),e.allowUnpay?(i(),I(b,{key:0,preset:"plain",size:"small",color:"secondary",icon:"undo",title:"Reverse All Payments",onClick:C=>e.$emit("unpay",d)},null,8,["onClick"])):v("",!0)])):(i(),I(b,{key:2,size:"small",color:"primary",onClick:C=>e.$emit("record-payment",d)},{default:l(()=>t[5]||(t[5]=[h(" Record Payment ")])),_:2},1032,["onClick"]))])],2))),128))])),e.summary?(i(),c("div",Ce,[a("div",Pe,[n(p,{name:"check_circle",color:"success",size:"small"}),a("span",null,"Paid: "+o(e.formatCurrency(e.summary.total_paid)),1)]),t[6]||(t[6]=a("div",{class:"summary-divider"},"|",-1)),a("div",$e,[n(p,{name:"pending",color:"warning",size:"small"}),a("span",null,"Remaining: "+o(e.formatCurrency(e.summary.total_unpaid)),1)]),t[7]||(t[7]=a("div",{class:"summary-divider"},"|",-1)),a("div",ke,[a("span",null,[h(o(e.summary.fully_paid_count||e.summary.paid_count)+"/"+o(e.totalInstallmentCount)+" Fully Paid ",1),e.summary.partial_paid_count?(i(),c(N,{key:0},[h(" ("+o(e.summary.partial_paid_count)+" partial) ",1)],64)):v("",!0)])])])):v("",!0),e.summary?(i(),c("div",Ve,[n(u,{"model-value":e.paymentPercentage,color:e.paymentPercentage===100?"success":"primary","show-percent":""},null,8,["model-value","color"])])):v("",!0)]),_:1})]),_:1})}const Fe=B(oe,[["render",Ie],["__scopeId","data-v-d5091453"]]),Ae=T({name:"PaymentModal",props:{modelValue:{type:Boolean,default:!1},installment:{type:Object,default:null},loading:{type:Boolean,default:!1}},emits:["update:modelValue","submit"],data(){return{form:{amount_paid:null,payment_reference:"",paid_at:new Date}}},computed:{isFormValid(){return!!this.form.amount_paid&&this.form.amount_paid>0},hasPartialPayment(){return this.installment?this.installment.payment_status==="partial"||(this.installment.amount_paid||0)>0:!1},remainingBalance(){return this.installment?this.installment.remaining_balance!==void 0?this.installment.remaining_balance:(this.installment.amount_due||0)-(this.installment.amount_paid||0):0},willCompleteInstallment(){return!this.installment||!this.form.amount_paid?!1:this.form.amount_paid>=this.remainingBalance},triggersStage(){var s,r;if(!this.installment)return null;if(this.installment.triggers_stage)return this.installment.triggers_stage;const e=((s=this.installment.narration)==null?void 0:s.toLowerCase())||"",t=((r=this.installment.installment_type)==null?void 0:r.toLowerCase())||"";return t.includes("deposit_booking")||e.includes("deposit")&&e.includes("booking")?"provision_sales":t.includes("final_payment")||e.includes("final")&&e.includes("90")?"confirmed":t.includes("trophy_deposit")||e.includes("trophy")&&e.includes("45")?"completed":null},requiredRule(){return e=>!!e||"Amount is required"},positiveAmountRule(){return e=>e&&Number(e)>0||"Amount must be positive"}},watch:{modelValue(e){e&&this.installment&&(this.form.amount_paid=null,this.form.payment_reference="",this.form.paid_at=new Date)}},methods:{formatCurrency(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)},formatStageName(e){return{pending:"PENDING",provision_sales:"PROVISION SALES",confirmed:"CONFIRMED",completed:"COMPLETED"}[e]||e.replace(/_/g," ").toUpperCase()},handleCancel(){this.$emit("update:modelValue",!1)},handleSubmit(){if(!this.installment||!this.isFormValid)return;const e={installment_id:this.installment.id,amount_paid:this.form.amount_paid,payment_reference:this.form.payment_reference||void 0,paid_at:this.form.paid_at?this.formatDateForApi(this.form.paid_at):void 0};this.$emit("submit",e)},formatDateForApi(e){const t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${r}`}}}),De={class:"payment-modal-content"},Ne={class:"installment-info mb-6"},Te={class:"info-header"},Be={class:"info-amount"},Ee={class:"amount"},Ue={key:0,class:"partial-payment-info mt-3"},Me={class:"flex justify-between text-sm"},Re={class:"text-green-600 font-medium"},Le={class:"flex justify-between text-sm mt-1"},je={class:"text-orange-600 font-semibold"},Oe={key:0,class:"stage-warning mb-6"},qe={key:1,class:"partial-notice mb-6"},ze={class:"payment-form"},He={class:"modal-actions"};function Ge(e,t,s,r,y,g){const p=f("VaIcon"),S=f("VaInput"),u=f("VaDateInput"),_=f("VaButton"),b=f("VaModal");return i(),I(b,{"model-value":e.modelValue,title:"Record Payment",size:"medium","hide-default-actions":!0,"onUpdate:modelValue":t[3]||(t[3]=w=>e.$emit("update:modelValue",w))},{default:l(()=>{var w,P,d;return[a("div",De,[a("div",Ne,[a("div",Te,[n(p,{name:"receipt_long",color:"primary"}),a("span",null,o(((w=e.installment)==null?void 0:w.narration)||"Payment"),1)]),a("div",Be,[t[4]||(t[4]=a("span",{class:"label"},"Amount Due:",-1)),a("span",Ee,o(e.formatCurrency(((P=e.installment)==null?void 0:P.amount_due)||0)),1)]),e.hasPartialPayment?(i(),c("div",Ue,[a("div",Me,[t[5]||(t[5]=a("span",{class:"text-gray-600"},"Already Paid:",-1)),a("span",Re,o(e.formatCurrency(((d=e.installment)==null?void 0:d.amount_paid)||0)),1)]),a("div",Le,[t[6]||(t[6]=a("span",{class:"text-gray-600"},"Remaining Balance:",-1)),a("span",je,o(e.formatCurrency(e.remainingBalance)),1)])])):v("",!0)]),e.triggersStage&&e.willCompleteInstallment?(i(),c("div",Oe,[n(p,{name:"flash_on",color:"warning"}),a("span",null,[t[7]||(t[7]=h(" This payment will move the sale to ")),a("strong",null,o(e.formatStageName(e.triggersStage)),1),t[8]||(t[8]=h(" stage "))])])):v("",!0),!e.willCompleteInstallment&&e.form.amount_paid?(i(),c("div",qe,[n(p,{name:"info",color:"info"}),t[9]||(t[9]=a("span",null,"This is a partial payment.",-1))])):v("",!0),a("div",ze,[n(S,{modelValue:e.form.amount_paid,"onUpdate:modelValue":t[0]||(t[0]=C=>e.form.amount_paid=C),modelModifiers:{number:!0},type:"number",label:"Amount Paid",placeholder:"Enter amount",class:"mb-4",rules:[e.requiredRule,e.positiveAmountRule]},{prependInner:l(()=>t[10]||(t[10]=[a("span",{class:"text-gray-500"},"$",-1)])),_:1},8,["modelValue","rules"]),n(S,{modelValue:e.form.payment_reference,"onUpdate:modelValue":t[1]||(t[1]=C=>e.form.payment_reference=C),label:"Payment Reference",placeholder:"e.g., TRX-2025-001",class:"mb-4"},null,8,["modelValue"]),n(u,{modelValue:e.form.paid_at,"onUpdate:modelValue":t[2]||(t[2]=C=>e.form.paid_at=C),label:"Payment Date",class:"mb-4",clearable:!1},null,8,["modelValue"])]),a("div",He,[n(_,{preset:"secondary",onClick:e.handleCancel},{default:l(()=>t[11]||(t[11]=[h(" Cancel ")])),_:1},8,["onClick"]),n(_,{color:"primary",loading:e.loading,disabled:!e.isFormValid,onClick:e.handleSubmit},{default:l(()=>t[12]||(t[12]=[h(" Record Payment ")])),_:1},8,["loading","disabled","onClick"])])])]}),_:1},8,["model-value"])}const We=B(Ae,[["render",Ge],["__scopeId","data-v-9500179c"]]),Qe=T({name:"ProposalView",components:{StageIndicator:ne,PaymentTable:Fe,PaymentModal:We},props:{proposal:{type:Object,required:!0}},emits:["edit","status-change","payment-recorded"],data(){return{showStatusModal:!1,showPaymentModal:!1,selectedInstallment:null,newStatus:null,loadingPayments:!1,savingPayment:!1,speciesColumns:[{key:"species_name",label:"Species",sortable:!0},{key:"quantity",label:"Quantity",sortable:!0,width:120}],statusOptions:[{value:"pending",text:"Pending"},{value:"provision_sales",text:"Provisional Sale"},{value:"confirmed",text:"Confirmed"},{value:"declined",text:"Declined"},{value:"cancelled",text:"Cancelled"},{value:"completed",text:"Completed"}]}},computed:{...L(Q,["logo"]),...L(j,["paymentStatus"]),logoUrl(){return this.logo||null},canBeCancelled(){const e=this.proposal.status;return e==="pending"||e==="provision_sales"||e==="confirmed"},paymentInstallments(){var e,t;return(e=this.paymentStatus)!=null&&e.installments?this.paymentStatus.installments:(((t=this.proposal.pricing)==null?void 0:t.installments)||[]).map(s=>({...s,is_paid:s.is_paid||!1,paid_at:s.paid_at||null,amount_paid:s.amount_paid||null,payment_reference:s.payment_reference||null}))},paymentSummary(){var y;if((y=this.paymentStatus)!=null&&y.summary)return this.paymentStatus.summary;const e=this.paymentInstallments,t=e.reduce((g,p)=>g+(p.amount_due||0),0),s=e.reduce((g,p)=>g+(p.is_paid?p.amount_paid||p.amount_due:0),0),r=e.filter(g=>g.is_paid).length;return{total_due:t,total_paid:s,total_unpaid:t-s,paid_count:r,unpaid_count:e.length-r}}},watch:{"proposal.id":{handler(){this.loadPaymentStatus()}}},mounted(){this.loadPaymentStatus()},methods:{...W(j,["fetchPayments","recordPayment","unpayInstallment"]),async loadPaymentStatus(){var e;if((e=this.proposal)!=null&&e.id){this.loadingPayments=!0;try{await this.fetchPayments(this.proposal.id)}catch(t){console.error("Error loading payment status:",t)}finally{this.loadingPayments=!1}}},formatDate(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}catch{return e}},formatCurrency(e){return e?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e):"$0"},getStatusColor(e){return{pending:"warning",provision_sales:"info",confirmed:"success",declined:"danger",cancelled:"secondary",completed:"primary"}[e]||"secondary"},formatStatus(e){return e?e.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase()):"N/A"},printProposal(){window.print()},async downloadPdf(){var e,t,s,r,y,g,p;if(!((e=this.proposal)!=null&&e.id)){(t=this.$vaToast)==null||t.init({message:"No proposal selected",color:"warning"});return}try{(s=this.$vaToast)==null||s.init({message:"Generating PDF...",color:"info"});const u=await(await fetch(`https://backend-bushman-master-kxhmlj.laravel.cloud/api/v1.0/sales-confirmation/proposals/${this.proposal.id}/pdf`)).json();if(u.success){const _=atob(u.pdf),b=new Array(_.length);for(let F=0;F<_.length;F++)b[F]=_.charCodeAt(F);const w=new Uint8Array(b),P=new Blob([w],{type:"application/pdf"}),d=window.URL.createObjectURL(P),C=document.createElement("a");C.href=d,C.download=`Sales_Confirmation_${u.client_name||((r=this.proposal.client)==null?void 0:r.full_name)||"Proposal"}.pdf`,C.click(),window.URL.revokeObjectURL(d),(y=this.$vaToast)==null||y.init({message:"PDF downloaded successfully",color:"success"})}else(g=this.$vaToast)==null||g.init({message:u.message||"Failed to generate PDF",color:"danger"})}catch(S){console.error("Error downloading PDF:",S),(p=this.$vaToast)==null||p.init({message:"Failed to download PDF",color:"danger"})}},confirmProposal(){this.newStatus="confirmed",this.showStatusModal=!0},changeToStage(e){this.$emit("status-change",{id:this.proposal.id,status:e})},changeStatus(){this.newStatus&&(this.$emit("status-change",{id:this.proposal.id,status:this.newStatus}),this.showStatusModal=!1,this.newStatus=null)},openPaymentModal(e){this.selectedInstallment=e,this.showPaymentModal=!0},async handlePaymentSubmit(e){var t,s,r,y,g;this.savingPayment=!0;try{const p=await this.recordPayment(e.installment_id,{amount_paid:e.amount_paid,payment_reference:e.payment_reference,paid_at:e.paid_at});this.showPaymentModal=!1,this.selectedInstallment=null;let S="Payment recorded successfully";p.stage_changed?S=p.message||`Payment recorded. Stage updated to ${this.formatStatus(p.new_stage||"")}`:((t=p.data)==null?void 0:t.payment_status)==="partial"&&(S=`Partial payment recorded. Remaining balance: ${this.formatCurrency(p.data.remaining_balance)}`),(s=this.$vaToast)==null||s.init({message:S,color:"success"}),this.$emit("payment-recorded",p),await this.loadPaymentStatus()}catch(p){(g=this.$vaToast)==null||g.init({message:((y=(r=p.response)==null?void 0:r.data)==null?void 0:y.message)||"Failed to record payment",color:"danger"})}finally{this.savingPayment=!1}},async handleUnpay(e){var t,s,r,y;if(confirm(`Are you sure you want to reverse the payment for "${e.narration}"?`)){this.savingPayment=!0;try{await this.unpayInstallment(e.id),(t=this.$vaToast)==null||t.init({message:"Payment reversed successfully",color:"success"}),await this.loadPaymentStatus()}catch(g){(y=this.$vaToast)==null||y.init({message:((r=(s=g.response)==null?void 0:s.data)==null?void 0:r.message)||"Failed to reverse payment",color:"danger"})}finally{this.savingPayment=!1}}}}}),Xe={class:"proposal-view"},Ye={class:"proposal-header"},Je={class:"flex justify-between items-start mb-6"},Ke={class:"logo-section"},Ze=["src"],xe={key:1,class:"text-xl font-bold text-primary"},et={class:"text-right"},tt={class:"text-gray-600"},at={class:"action-buttons mb-6 flex flex-wrap justify-end gap-3"},st={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},nt={class:"info-row"},ot={class:"value"},lt={class:"info-row"},rt={class:"value"},it={class:"info-row"},dt={class:"value font-semibold"},pt={class:"info-row"},ut={class:"value"},mt={class:"info-row"},ct={class:"value"},yt={class:"info-row"},ft={class:"value"},ht={class:"info-row"},gt={class:"value"},_t={class:"info-row"},vt={class:"value"},bt={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},wt={class:"info-row"},St={class:"value"},Ct={class:"info-row"},Pt={class:"value"},$t={class:"info-row"},kt={class:"value"},Vt={class:"info-row"},It={class:"value"},Ft={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},At={class:"stat-card"},Dt={class:"stat-value"},Nt={class:"stat-card"},Tt={class:"stat-value"},Bt={class:"stat-card"},Et={class:"stat-value"},Ut={class:"flex flex-col"},Mt={class:"font-semibold"},Rt={class:"text-xs text-gray-500 italic"},Lt={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},jt={class:"info-row"},Ot={class:"value font-mono"},qt={class:"info-row"},zt={class:"value"},Ht={class:"info-row"},Gt={class:"value"},Wt={class:"info-row"},Qt={class:"value"},Xt={class:"text-gray-700"},Yt={class:"p-4"},Jt={class:"flex justify-end gap-3"};function Kt(e,t,s,r,y,g){var U;const p=f("VaChip"),S=f("StageIndicator"),u=f("VaButton"),_=f("VaIcon"),b=f("VaCardTitle"),w=f("VaCardContent"),P=f("VaCard"),d=f("VaBadge"),C=f("VaDataTable"),F=f("PaymentTable"),O=f("PaymentModal"),q=f("VaSelect"),z=f("VaModal");return i(),c("div",Xe,[a("div",Ye,[a("div",Je,[a("div",Ke,[e.logoUrl?(i(),c("img",{key:0,src:e.logoUrl,alt:"Company Logo",class:"h-16"},null,8,Ze)):(i(),c("h2",xe,"Bushman Safari Trackers Limited"))]),a("div",et,[t[6]||(t[6]=a("h1",{class:"text-2xl font-bold text-gray-800 mb-2"},"SALES CONFIRMATION",-1)),a("p",tt," Date: "+o(e.proposal.confirmation_date_formatted||e.formatDate(e.proposal.confirmation_date)),1),n(p,{color:e.getStatusColor(e.proposal.status),size:"small",class:"mt-2"},{default:l(()=>[h(o(e.formatStatus(e.proposal.status)),1)]),_:1},8,["color"])])])]),e.proposal.status?(i(),I(S,{key:0,"current-stage":e.proposal.status,installments:e.paymentInstallments,class:"mb-6"},null,8,["current-stage","installments"])):v("",!0),a("div",at,[n(u,{preset:"secondary",icon:"print",onClick:e.printProposal},{default:l(()=>t[7]||(t[7]=[h(" Print ")])),_:1},8,["onClick"]),n(u,{preset:"secondary",icon:"download",onClick:e.downloadPdf},{default:l(()=>t[8]||(t[8]=[h(" Download PDF ")])),_:1},8,["onClick"]),n(u,{color:"primary",icon:"edit",onClick:t[0]||(t[0]=m=>e.$emit("edit",e.proposal))},{default:l(()=>t[9]||(t[9]=[h(" Edit ")])),_:1}),e.canBeCancelled?(i(),I(u,{key:0,color:"secondary",icon:"cancel",onClick:t[1]||(t[1]=m=>e.changeToStage("cancelled"))},{default:l(()=>t[10]||(t[10]=[h(" Cancel ")])),_:1})):v("",!0)]),a("div",st,[n(P,{outlined:""},{default:l(()=>[n(b,{class:"flex items-center gap-2"},{default:l(()=>[n(_,{name:"support_agent",color:"primary"}),t[11]||(t[11]=h(" Sales Agent "))]),_:1}),n(w,null,{default:l(()=>{var m,$;return[a("div",nt,[t[12]||(t[12]=a("span",{class:"label"},"Name:",-1)),a("span",ot,o(((m=e.proposal.sales_agent)==null?void 0:m.name)||"N/A"),1)]),a("div",lt,[t[13]||(t[13]=a("span",{class:"label"},"Email:",-1)),a("span",rt,o((($=e.proposal.sales_agent)==null?void 0:$.email)||"N/A"),1)])]}),_:1})]),_:1}),n(P,{outlined:""},{default:l(()=>[n(b,{class:"flex items-center gap-2"},{default:l(()=>[n(_,{name:"person",color:"primary"}),t[14]||(t[14]=h(" Client Information "))]),_:1}),n(w,null,{default:l(()=>{var m,$,k,A,M,R;return[a("div",it,[t[15]||(t[15]=a("span",{class:"label"},"Name:",-1)),a("span",dt,o(((m=e.proposal.client)==null?void 0:m.full_name)||"N/A"),1)]),a("div",pt,[t[16]||(t[16]=a("span",{class:"label"},"Address:",-1)),a("span",ut,o((($=e.proposal.client)==null?void 0:$.address)||"N/A"),1)]),a("div",mt,[t[17]||(t[17]=a("span",{class:"label"},"Home Tel:",-1)),a("span",ct,o(((k=e.proposal.client)==null?void 0:k.home_tel)||"N/A"),1)]),a("div",yt,[t[18]||(t[18]=a("span",{class:"label"},"Work Tel:",-1)),a("span",ft,o(((A=e.proposal.client)==null?void 0:A.work_tel)||"N/A"),1)]),a("div",ht,[t[19]||(t[19]=a("span",{class:"label"},"Cell:",-1)),a("span",gt,o(((M=e.proposal.client)==null?void 0:M.cell)||"N/A"),1)]),a("div",_t,[t[20]||(t[20]=a("span",{class:"label"},"Email:",-1)),a("span",vt,o(((R=e.proposal.client)==null?void 0:R.email)||"N/A"),1)])]}),_:1})]),_:1})]),n(P,{outlined:"",class:"mb-6"},{default:l(()=>[n(b,{class:"flex items-center gap-2"},{default:l(()=>[n(_,{name:"landscape",color:"primary"}),t[21]||(t[21]=h(" Hunting Trip Details "))]),_:1}),n(w,null,{default:l(()=>{var m,$,k,A;return[a("div",bt,[a("div",wt,[t[22]||(t[22]=a("span",{class:"label"},"Type of Safari:",-1)),a("span",St,o(((m=e.proposal.hunting_trip)==null?void 0:m.type)||"N/A"),1)]),a("div",Ct,[t[23]||(t[23]=a("span",{class:"label"},"Hunting Area:",-1)),a("span",Pt,o((($=e.proposal.hunting_trip)==null?void 0:$.hunting_area)||"N/A"),1)]),a("div",$t,[t[24]||(t[24]=a("span",{class:"label"},"Outfitter:",-1)),a("span",kt,o(((k=e.proposal.hunting_trip)==null?void 0:k.outfitter)||"Bushman Safari Trackers Limited"),1)]),a("div",Vt,[t[25]||(t[25]=a("span",{class:"label"},"Dates:",-1)),a("span",It,o(((A=e.proposal.hunting_trip)==null?void 0:A.dates)||"N/A"),1)])])]}),_:1})]),_:1}),n(P,{outlined:"",class:"mb-6"},{default:l(()=>[n(b,{class:"flex items-center gap-2"},{default:l(()=>[n(_,{name:"groups",color:"primary"}),t[26]||(t[26]=h(" Details of Trip "))]),_:1}),n(w,null,{default:l(()=>{var m,$,k;return[a("div",Ft,[a("div",At,[a("div",Dt,o(((m=e.proposal.trip_details)==null?void 0:m.no_of_hunters)||0),1),t[27]||(t[27]=a("div",{class:"stat-label"},"Hunters",-1))]),a("div",Nt,[a("div",Tt,o((($=e.proposal.trip_details)==null?void 0:$.no_of_observers)||0),1),t[28]||(t[28]=a("div",{class:"stat-label"},"Observers",-1))]),a("div",Bt,[a("div",Et,o(((k=e.proposal.trip_details)==null?void 0:k.no_of_companions)||0),1),t[29]||(t[29]=a("div",{class:"stat-label"},"Companions",-1))])])]}),_:1})]),_:1}),n(P,{outlined:"",class:"mb-6"},{default:l(()=>[n(b,{class:"flex items-center gap-2"},{default:l(()=>[n(_,{name:"pets",color:"primary"}),t[30]||(t[30]=h(" Hunt Combination "))]),_:1}),n(w,null,{default:l(()=>[n(C,{items:e.proposal.hunt_combination||[],columns:e.speciesColumns,hoverable:"",striped:""},{"cell(species_name)":l(({rowData:m})=>[a("div",Ut,[a("span",Mt,o(m.species_name),1),a("span",Rt,o(m.scientific_name),1)])]),"cell(quantity)":l(({rowData:m})=>[n(d,{text:String(m.quantity),color:"primary"},null,8,["text"])]),_:1},8,["items","columns"])]),_:1})]),_:1}),n(F,{installments:e.paymentInstallments,summary:e.paymentSummary,"total-amount":((U=e.proposal.pricing)==null?void 0:U.total_amount)||0,loading:e.loadingPayments,"allow-unpay":!0,onRecordPayment:e.openPaymentModal,onUnpay:e.handleUnpay},null,8,["installments","summary","total-amount","loading","onRecordPayment","onUnpay"]),n(P,{outlined:"",class:"mb-6 bg-gray-50"},{default:l(()=>[n(b,{class:"flex items-center gap-2"},{default:l(()=>[n(_,{name:"link",color:"info"}),t[31]||(t[31]=h(" Linked Sales Inquiry "))]),_:1}),n(w,null,{default:l(()=>{var m,$,k;return[a("div",Lt,[a("div",jt,[t[32]||(t[32]=a("span",{class:"label"},"Inquiry Code:",-1)),a("span",Ot,o(((m=e.proposal.sales_inquiry)==null?void 0:m.code)||"N/A"),1)]),a("div",qt,[t[33]||(t[33]=a("span",{class:"label"},"Created Date:",-1)),a("span",zt,o((($=e.proposal.sales_inquiry)==null?void 0:$.created_date)||"N/A"),1)]),a("div",Ht,[t[34]||(t[34]=a("span",{class:"label"},"Season:",-1)),a("span",Gt,o(((k=e.proposal.sales_inquiry)==null?void 0:k.season)||"N/A"),1)]),a("div",Wt,[t[35]||(t[35]=a("span",{class:"label"},"Hunting License:",-1)),a("span",Qt,o(e.proposal.hunting_license||"N/A"),1)])])]}),_:1})]),_:1}),e.proposal.remarks?(i(),I(P,{key:1,outlined:"",class:"mb-6"},{default:l(()=>[n(b,{class:"flex items-center gap-2"},{default:l(()=>[n(_,{name:"notes",color:"primary"}),t[36]||(t[36]=h(" Remarks "))]),_:1}),n(w,null,{default:l(()=>[a("p",Xt,o(e.proposal.remarks),1)]),_:1})]),_:1})):v("",!0),n(O,{modelValue:e.showPaymentModal,"onUpdate:modelValue":t[2]||(t[2]=m=>e.showPaymentModal=m),installment:e.selectedInstallment,loading:e.savingPayment,onSubmit:e.handlePaymentSubmit},null,8,["modelValue","installment","loading","onSubmit"]),n(z,{modelValue:e.showStatusModal,"onUpdate:modelValue":t[5]||(t[5]=m=>e.showStatusModal=m),title:"Change Proposal Status","hide-default-actions":!0},{default:l(()=>[a("div",Yt,[n(q,{modelValue:e.newStatus,"onUpdate:modelValue":t[3]||(t[3]=m=>e.newStatus=m),options:e.statusOptions,label:"Select New Status",class:"mb-4"},null,8,["modelValue","options"]),a("div",Jt,[n(u,{preset:"secondary",onClick:t[4]||(t[4]=m=>e.showStatusModal=!1)},{default:l(()=>t[37]||(t[37]=[h("Cancel")])),_:1}),n(u,{color:"primary",onClick:e.changeStatus},{default:l(()=>t[38]||(t[38]=[h("Confirm")])),_:1},8,["onClick"])])])]),_:1},8,["modelValue"])])}const ea=B(Qe,[["render",Kt],["__scopeId","data-v-5ae67f1e"]]);export{ea as P,j as u};
//# sourceMappingURL=ProposalView-BQM6_c6S.js.map
