{"version":3,"file":"contracts-store-BRTk1SGi.js","sources":["../../src/stores/contracts-store.ts"],"sourcesContent":["// VITE_APP_SALES_CONFIRMATION_CONTRACT_VSET_URL\n\nimport { defineStore } from 'pinia'\nimport axios from 'axios'\nimport { format } from 'date-fns'\nimport { formatDateTime } from '../services/utils'\n\nexport const useContractsStore = defineStore('sales_contracts', {\n  state: () => {\n    return {\n      contracts: [] as any,\n      loadingContracts: false,\n      permits: [] as any,\n      loadingPermits: false,\n    }\n  },\n\n  actions: {\n    async getContracts(contractorType: string = 'MAIN_HUNTER') {\n      this.loadingContracts = true\n      // Use new endpoint: api/v1.0/contracts\n      const url =\n        import.meta.env.VITE_APP_BASE_URL + 'contracts' + (contractorType ? `?contractor_type=${contractorType}` : '')\n\n      const config = {\n        method: 'get',\n        maxBodyLength: Infinity,\n        url: url,\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      }\n      try {\n        const response = await axios.request(config)\n\n        if (response.status === 200) {\n          // Handle paginated response: {current_page: 1, data: [...]}\n          let contractsData = []\n          if (response.data.data && Array.isArray(response.data.data)) {\n            contractsData = response.data.data\n          } else if (Array.isArray(response.data)) {\n            contractsData = response.data\n          } else if (response.data.value && Array.isArray(response.data.value)) {\n            contractsData = response.data.value\n          }\n\n          this.contracts = contractsData.map((contract: any) => {\n            // Extract client name from entity or sales_confirmation_proposal\n            const clientName =\n              contract.entity?.full_name ||\n              contract.sales_confirmation_proposal?.client?.full_name ||\n              contract.client_name ||\n              'Unknown Client'\n\n            return {\n              id: contract.id,\n              contract_number: contract.contract_number,\n              start_date: formatDateTime(contract.start_date),\n              end_date: formatDateTime(contract.end_date),\n              created_at: formatDateTime(contract.created_at),\n              updated_at: formatDateTime(contract.updated_at),\n              description: contract.description,\n              sales_confirmation_proposal_id: contract.sales_confirmation_proposal_id,\n              entity_id: contract.entity_id,\n              contractor_type: contract.contractor_type,\n              client_name: clientName,\n              pdf: contract.pdf,\n              // Include full nested data\n              entity: contract.entity,\n              sales_confirmation_proposal: contract.sales_confirmation_proposal,\n              selfitem: contract,\n            }\n          })\n          this.loadingContracts = false\n          return response\n        }\n        console.log(this.contracts)\n        return response\n      } catch (error) {\n        this.loadingContracts = false\n        console.log(error)\n        return error\n      }\n    },\n\n    async getContractPermits() {\n      const url = import.meta.env.VITE_APP_BASE_URL + import.meta.env.VITE_APP_ENTITY_CONTRACT_PERMIT_VSET_URL\n      const config = {\n        method: 'get',\n        maxBodyLength: Infinity,\n        url: url,\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      }\n      const response = await axios.request(config)\n\n      if (response.status === 200) {\n        this.permits = response.data.map((permit: any) => {\n          return {\n            permit_number: permit.permit_number,\n            issued_date: formatDateTime(permit.issued_date),\n            description: permit.description,\n            start_date: formatDateTime(permit.dates[0].start_date),\n            expiry_date: formatDateTime(permit.dates[0].end_date),\n            updated_at: formatDateTime(permit.updated_at),\n            entity_contract_id: permit.entity_contract_id,\n            package_type: permit.package_type,\n            pdf: permit.pdf,\n            selfitem: permit,\n          }\n        })\n\n        this.loadingPermits = false\n        return response\n      }\n    },\n\n    async createPermit(payload: any) {\n      const url = import.meta.env.VITE_APP_BASE_URL + import.meta.env.VITE_APP_ENTITY_CONTRACT_PERMIT_VSET_URL\n      const data = JSON.stringify({\n        entity_contract_id: payload.entity_contract_id,\n        permit_number: payload.permit_number,\n        issued_date: format(payload.issued_date, 'yyyy-MM-dd'),\n        package_type: payload.package_type,\n        description: payload.description,\n        start_date: format(payload.start_date, 'yyyy-MM-dd'),\n        end_date: format(payload.end_date, 'yyyy-MM-dd'),\n      })\n\n      const config = {\n        method: 'post',\n        maxBodyLength: Infinity,\n        url: url,\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: data,\n      }\n\n      const response = await axios.request(config)\n      return response\n    },\n\n    async createContract(payload: any) {\n      const url = import.meta.env.VITE_APP_BASE_URL + import.meta.env.VITE_APP_SALES_CONFIRMATION_CONTRACT_VSET_URL\n\n      // Backend automatically gets start_date and end_date from sales inquiry preferences\n      // Include contractor_type as null to satisfy backend validation\n      const contractData = {\n        sales_confirmation_proposal_id: payload.sales_confirmation_proposal_id,\n        entity_id: payload.entity_id || null,\n        contractor_type: null,\n        description: payload.description || '',\n      }\n\n      console.log('Creating contract with payload:', contractData)\n\n      const config = {\n        method: 'post',\n        maxBodyLength: Infinity,\n        url: url,\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: JSON.stringify(contractData),\n      }\n\n      try {\n        const response = await axios.request(config)\n        return response\n      } catch (error: any) {\n        console.error('Contract creation error:', error.response?.data)\n        throw error\n      }\n    },\n\n    async deleteContractById(contractId: number) {\n      // Use the correct DELETE endpoint: sales-confirmation/contracts/{id}/\n      const url = import.meta.env.VITE_APP_BASE_URL + 'sales-confirmation/contracts/' + contractId + '/'\n\n      console.log('Attempting to delete contract at URL:', url)\n\n      const config = {\n        method: 'delete',\n        maxBodyLength: Infinity,\n        url: url,\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      }\n\n      try {\n        const response = await axios.request(config)\n        console.log('Contract deleted successfully:', response)\n        return response\n      } catch (error: any) {\n        console.error('Contract deletion error - Status:', error.response?.status)\n        console.error('Contract deletion error - Data:', error.response?.data)\n        console.error('Contract deletion error - Full error:', error)\n        throw error\n      }\n    },\n  },\n})\n"],"names":["useContractsStore","defineStore","contractorType","config","response","axios","contractsData","contract","clientName","_a","_c","_b","formatDateTime","error","permit","payload","url","data","format","contractData","contractId"],"mappings":"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"}